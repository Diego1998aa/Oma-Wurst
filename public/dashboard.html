<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Oma Wurst</title>
    <!-- En entorno Vite (desarrollo), servimos CSS desde src -->
    <link rel="stylesheet" href="/src/css/styles.css">
    <link rel="stylesheet" href="/src/css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/assets/logo-oma-final.png" alt="Oma Wurst Logo" class="sidebar-logo">
                <h1 class="sidebar-title">Oma Wurst</h1>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="active"><a href="#" data-target="dashboard-section"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#" data-target="reservas-section"><i class="fas fa-calendar-alt"></i> Reservas</a></li>
                    <li><a href="#" data-target="productos-section"><i class="fas fa-box"></i> Productos</a></li>
                    <li><a href="#" data-target="usuarios-section"><i class="fas fa-users"></i> Usuarios</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="#" id="logout-button">Cerrar Sesión</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <h2 id="main-title">Panel de Administración</h2>
                <div class="admin-profile">
                    <span id="user-email"></span>
                    <i class="fas fa-user-circle"></i>
                </div>
            </header>

            <!-- DASHBOARD -->
            <section id="dashboard-section" class="main-section active">
                <div class="kpi-cards">
                    <div class="kpi-card">
                        <h4>Usuarios Registrados</h4>
                        <p id="kpi-usuarios-registrados">--</p>
                    </div>
                    <div class="kpi-card">
                        <h4>Usuarios Activos</h4>
                        <p id="kpi-usuarios-activos">--</p>
                    </div>
                    <div class="kpi-card">
                        <h4>Nuevas Reservas (Mes)</h4>
                        <p id="kpi-nuevas-reservas">--</p>
                    </div>
                </div>
                <div class="data-table-section">
                    <h3>Últimas Reservas</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="ultimas-reservas-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- RESERVAS -->
            <section id="reservas-section" class="main-section">
                <div class="controls-section">
                    <div class="filters">
                        <select id="status-filter">
                            <option value="all">Todos los estados</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Confirmado">Confirmado</option>
                            <option value="Completado">Completado</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                        <input type="date" id="date-filter">
                    </div>
                    <div class="view-switcher">
                        <button id="btn-view-calendar" class="view-btn active"><i class="fas fa-calendar-alt"></i> Calendario</button>
                        <button id="btn-view-list" class="view-btn"><i class="fas fa-list"></i> Lista</button>
                    </div>
                </div>
                <div class="content-view">
                    <div id="calendar-view" class="view active">
                        <div id="calendar-container"></div>
                    </div>
                    <div id="list-view" class="view">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID Reserva</th>
                                        <th>Cliente</th>
                                        <th>Fecha de Entrega</th>
                                        <th>Estado</th>
                                        <th>Total</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="reservas-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PRODUCTOS -->
            <section id="productos-section" class="main-section">
                <div class="controls-section products-controls">
                    <div class="products-controls-header">
                        <div>
                            <h3>Gestión de Productos</h3>
                            <p class="products-subtitle">Administra el catálogo en tiempo real, busca por nombre o categoría y crea nuevos productos cuando los necesites.</p>
                        </div>
                        <div class="products-actions">
                            <button id="refresh-products-btn" class="btn-product-card secondary" type="button">
                                <i class="fas fa-rotate-right"></i> Actualizar
                            </button>
                            <button id="add-product-btn" class="btn-product-card primary" type="button">
                                <i class="fas fa-plus"></i> Agregar Producto
                            </button>
                        </div>
                    </div>
                    <div class="product-stats-grid">
                        <article class="product-stat-card">
                            <span>Total publicados</span>
                            <strong id="product-total-count">0</strong>
                        </article>
                        <article class="product-stat-card">
                            <span>Categorías activas</span>
                            <strong id="product-category-count">0</strong>
                        </article>
                        <article class="product-stat-card">
                            <span>Sin imagen</span>
                            <strong id="product-missing-images-count">0</strong>
                        </article>
                    </div>
                    <div class="product-filters">
                        <label class="product-search-field">
                            <i class="fas fa-search"></i>
                            <input type="search" id="product-search-input" placeholder="Buscar por nombre, categoría o descripción">
                        </label>
                        <label>
                            <span class="sr-only">Filtrar por categoría</span>
                            <select id="product-category-filter">
                                <option value="all">Todas las categorías</option>
                            </select>
                        </label>
                        <label>
                            <span class="sr-only">Ordenar productos</span>
                            <select id="product-sort-select">
                                <option value="recent">Más recientes</option>
                                <option value="price_desc">Precio: mayor a menor</option>
                                <option value="price_asc">Precio: menor a mayor</option>
                                <option value="name_asc">Nombre A-Z</option>
                            </select>
                        </label>
                        <button id="product-reset-filters" class="btn-reset-filters" type="button">
                            <i class="fas fa-eraser"></i> Limpiar filtros
                        </button>
                    </div>
                </div>
                <div id="products-loading-indicator" class="products-loading-indicator" hidden>
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Sincronizando productos…</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Título</th>
                                <th>Categoría</th>
                                <th>Precio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                        </tbody>
                    </table>
                </div>
                <button id="quick-add-product-btn" class="fab-add-product btn-product-card primary" type="button" aria-label="Agregar nuevo producto">
                    <i class="fas fa-plus"></i>
                    <span>Nuevo producto</span>
                </button>
                <div id="products-empty-state" class="products-empty-state" hidden>
                    <p id="products-empty-message">No encontramos productos para los filtros seleccionados.</p>
                    <button type="button" class="btn-product-card primary" id="empty-state-add-product-btn">
                        <i class="fas fa-plus"></i> Crear el primero
                    </button>
                </div>
            </section>

            <!-- MODAL PRODUCTO -->
            <div id="product-modal" class="modal-admin">
                <div class="modal-admin-content">
                    <button id="modal-product-close-btn" class="modal-close-btn">×</button>
                    <h3 id="modal-product-title-form">Agregar Nuevo Producto</h3>
                    <form id="product-form">
                        <input type="hidden" id="product-id">
                        <div class="form-group">
                            <label for="product-title">Título</label>
                            <input type="text" id="product-title" required>
                        </div>
                        <div class="form-group">
                            <label for="product-description">Descripción</label>
                            <textarea id="product-description" rows="4" required></textarea>
                        </div>
                        <div class="form-group-row">
                            <div class="form-group">
                                <label for="product-category-select">Categoría</label>
                                <select id="product-category-select" required>
                                    <option value="" disabled selected>Selecciona una categoría</option>
                                </select>
                                <p class="form-help-text">Elige una categoría existente o crea una nueva.</p>
                            </div>
                            <div class="form-group">
                                <label for="product-price">Precio</label>
                                <input type="number" id="product-price" step="1" required>
                            </div>
                        </div>
                        <div class="form-group" id="new-category-wrapper" style="display:none;">
                            <label for="product-category-new">Nueva categoría</label>
                            <input type="text" id="product-category-new" placeholder="Ej: Parrilleros Premium">
                            <p class="form-help-text">Esta categoría se agregará al catálogo y quedará disponible en futuros productos.</p>
                        </div>
                        <div class="form-group">
                            <label for="product-images">Imágenes (la primera será la principal)</label>
                            <input type="file" id="product-images" multiple accept="image/*">
                            <div id="image-previews" class="image-previews"></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-submit">Guardar Producto</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- USUARIOS -->
            <section id="usuarios-section" class="main-section">
                <h2>Gestión de Usuarios</h2>
                <p>Esta sección está en construcción.</p>
            </section>
        </main>
    </div>

    <div id="dashboard-toast" class="dashboard-toast" aria-live="polite"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        // --- 1. CONFIGURACIÓN Y CONEXIÓN ---
        const { createClient } = supabase;
        const supabaseClient = createClient(
            import.meta.env.VITE_SUPABASE_URL,
            import.meta.env.VITE_SUPABASE_ANON_KEY
        );

        // --- 2. ELEMENTOS DEL DOM ---
        const userEmailElement = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const mainTitle = document.getElementById('main-title');
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        const mainSections = document.querySelectorAll('.main-section');

        // Reservas
        const calendarView = document.getElementById('calendar-view');
        const listView = document.getElementById('list-view');
        const btnViewCalendar = document.getElementById('btn-view-calendar');
        const btnViewList = document.getElementById('btn-view-list');
        const calendarContainer = document.getElementById('calendar-container');
        const reservasTableBody = document.getElementById('reservas-table-body');
        let calendar;
        let reservasData = [];

        // Productos
        const productsTableBody = document.getElementById('products-table-body');
        const productsLoadingIndicator = document.getElementById('products-loading-indicator');
        const productsEmptyState = document.getElementById('products-empty-state');
        const productsEmptyMessage = document.getElementById('products-empty-message');
        const productTotalCount = document.getElementById('product-total-count');
        const productCategoryCount = document.getElementById('product-category-count');
        const productMissingImagesCount = document.getElementById('product-missing-images-count');
        const productSearchInput = document.getElementById('product-search-input');
        const productCategoryFilter = document.getElementById('product-category-filter');
        const productSortSelect = document.getElementById('product-sort-select');
        const productResetFiltersBtn = document.getElementById('product-reset-filters');
        const refreshProductsBtn = document.getElementById('refresh-products-btn');
        const quickAddProductBtn = document.getElementById('quick-add-product-btn');
        const productsEmptyCtaBtn = document.getElementById('empty-state-add-product-btn');
        const dashboardToast = document.getElementById('dashboard-toast');
        const addProductBtn = document.getElementById('add-product-btn');
        const productModal = document.getElementById('product-modal');
        const modalProductCloseBtn = document.getElementById('modal-product-close-btn');
        const productForm = document.getElementById('product-form');
        const modalProductTitleForm = document.getElementById('modal-product-title-form');
        const imagePreviewsContainer = document.getElementById('image-previews');
        const productCategorySelectInput = document.getElementById('product-category-select');
        const newCategoryWrapper = document.getElementById('new-category-wrapper');
        const productCategoryNewInput = document.getElementById('product-category-new');
        let productsData = [];
        let removedImageUrls = new Set();
        const productFilters = { query: '', category: 'all', sort: 'recent' };
        let productsLoading = false;
        let toastTimeoutId = null;
        const NEW_CATEGORY_VALUE = '__new__';

        // --- 3. AUTENTICACIÓN Y SESIÓN ---
        let isAdmin = false;

        // Lee el rol desde la tabla profiles
        async function getUserRole(userId) {
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('role')
                .eq('id', userId)
                .maybeSingle();   // no lanza error si no hay fila

            if (error) {
                console.error('Error leyendo role desde profiles:', {
                    message: error.message,
                    details: error.details,
                    hint: error.hint,
                    code: error.code
                });
                return null;
            }

            console.log('Perfil desde BD:', data);
            return data?.role ?? null;
        }

        // Comprueba la sesión y aplica permisos según el rol en profiles
        async function checkSession() {
            const { data, error } = await supabaseClient.auth.getSession();
            if (error || !data.session) {
                window.location.href = 'login.html';
                return;
            }

            const session = data.session;
            const user = session.user;

            // 1) Rol real desde BD
            const dbRole = await getUserRole(user.id);  // debe devolver 'owner' en tu caso

            // 2) Rol efectivo: si no hay, asumimos 'customer'
            const effectiveRole = dbRole || 'customer';

            // 3) Es admin si está en estos roles
            isAdmin = ['owner', 'admin', 'staff'].includes(effectiveRole);

            // 4) Texto que se muestra en el header
            const roleLabel = isAdmin ? ` · ${effectiveRole}` : ' · Solo lectura';
            userEmailElement.textContent = user.email + roleLabel;

            // 5) Si no es admin, ocultamos el botón de agregar producto
            if (!isAdmin) {
                const addBtn = document.getElementById('add-product-btn');
                if (addBtn) addBtn.style.display = 'none';
                if (productsEmptyCtaBtn) productsEmptyCtaBtn.style.display = 'none';
                if (quickAddProductBtn) quickAddProductBtn.style.display = 'none';
            }

            setupNavigation();
            await loadDashboardData();
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        // --- 4. NAVEGACIÓN SPA ---
        function setupNavigation() {
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    showSection(targetId);
                    document.querySelector('.sidebar-nav li.active').classList.remove('active');
                    link.parentElement.classList.add('active');
                });
            });
        }

        function showSection(targetId) {
            mainSections.forEach(section => section.classList.remove('active'));
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.classList.add('active');
                const link = document.querySelector(`a[data-target="${targetId}"]`);
                const linkText = link.textContent.trim();
                mainTitle.textContent = linkText === 'Dashboard' ? 'Panel de Administración' : `Gestión de ${linkText}`;

                if (targetId === 'reservas-section' && reservasData.length === 0) {
                    loadReservasData();
                }
                if (targetId === 'productos-section' && productsData.length === 0) {
                    loadProductsData();
                }
            }
        }

        // --- 5. LÓGICA DE DATOS (Dashboard / Reservas) ---
        async function loadDashboardData() {
            document.getElementById('kpi-usuarios-registrados').textContent = '—';
            document.getElementById('kpi-usuarios-activos').textContent = '—';
            await loadReservasData();
            const now = new Date();
            const monthKey = now.toISOString().slice(0, 7); // yyyy-mm
            const countMonth = reservasData.filter(r => r.date.toISOString().slice(0, 7) === monthKey).length;
            document.getElementById('kpi-nuevas-reservas').textContent = String(countMonth);
        }

        async function loadReservasData() {
            let populated = false;
            try {
                const { data, error } = await supabaseClient
                    .from('reservations')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(200);
                if (!error && Array.isArray(data)) {
                    reservasData = data.map(mapReservationRecord);
                    populated = true;
                }
            } catch (e) {
                console.error('Error cargando reservations:', e);
            }

            // Fallback desde carrito
            if (!populated) {
                try {
                    const { data: cartRows, error: cartErr } = await supabaseClient
                        .from('cart')
                        .select('id,user_id,product_id,quantity,created_at')
                        .order('created_at', { ascending: false })
                        .limit(500);
                    if (!cartErr && Array.isArray(cartRows)) {
                        const { data: products } = await supabaseClient.from('products').select('id,price,title');
                        const priceMap = new Map((products || []).map(p => [String(p.id), Number(p.price) || 0]));
                        const grouped = new Map();
                        for (const row of cartRows) {
                            const key = row.user_id || 'anon';
                            const itemTotal = (priceMap.get(String(row.product_id)) || 0) * (row.quantity || 0);
                            if (!grouped.has(key)) {
                                grouped.set(key, {
                                    id: key.slice(0, 8),
                                    customer: key.slice(0, 8),
                                    date: new Date(row.created_at || Date.now()),
                                    status: 'Pendiente',
                                    total: 0,
                                    _src: 'cart'
                                });
                            }
                            const g = grouped.get(key);
                            g.total += itemTotal;
                            if (row.created_at && new Date(row.created_at) > g.date) g.date = new Date(row.created_at);
                        }
                        reservasData = Array.from(grouped.values());
                        populated = true;
                    }
                } catch (e) {
                    console.error('Error cargando reservas desde cart:', e);
                }
            }

            renderReservasUI();
        }

        function mapReservationRecord(r) {
            const id = r.id || r.reservation_id || r.uuid || '';
            const customer = r.customer_name || r.customer || r.client_name || r.name || (r.user_id ? String(r.user_id).slice(0, 8) : 'Cliente');
            const dateRaw = r.delivery_date || r.date || r.created_at || Date.now();
            const status = r.status || 'Pendiente';
            const total = Number(r.total || r.amount || r.total_amount || 0);
            return { id, customer, date: new Date(dateRaw), status, total, _src: 'reservations' };
        }

        function renderReservasUI() {
            renderReservasList();
            renderUltimasReservas();
            renderCalendar();
        }

        function formatCLP(n) {
            return new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                maximumFractionDigits: 0
            }).format(Math.round(n || 0));
        }

        function renderUltimasReservas() {
            const tbody = document.getElementById('ultimas-reservas-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            reservasData.slice(0, 5).forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.date.toLocaleDateString()}</td>
                    <td>${r.customer}</td>
                    <td><span class="status-badge status-${(r.status || 'Pendiente').toLowerCase()}">${r.status || 'Pendiente'}</span></td>
                    <td><button class="btn-product-card secondary" onclick="viewReserva('${r.id}')">Ver</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function renderReservasList() {
            const statusFilter = document.getElementById('status-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            let rows = reservasData;
            if (statusFilter && statusFilter !== 'all') {
                rows = rows.filter(r => (r.status || 'Pendiente') === statusFilter);
            }
            if (dateFilter) {
                const d = new Date(dateFilter);
                const iso = d.toISOString().slice(0, 10);
                rows = rows.filter(r => r.date.toISOString().slice(0, 10) === iso);
            }
            reservasTableBody.innerHTML = '';
            if (rows.length === 0) {
                reservasTableBody.innerHTML = '<tr><td colspan="6">No hay reservas para los filtros seleccionados.</td></tr>';
                return;
            }
            rows.forEach(r => {
                const canUpdate = (r._src === 'reservations') && isAdmin;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.id}</td>
                    <td>${r.customer}</td>
                    <td>${r.date.toLocaleString()}</td>
                    <td><span class="status-badge status-${(r.status || 'Pendiente').toLowerCase()}">${r.status || 'Pendiente'}</span></td>
                    <td>${formatCLP(r.total || 0)}</td>
                    <td>
                        ${canUpdate ? `
                            <button class="btn-product-card secondary" onclick="updateReservaStatus('${r.id}','Confirmado')">Confirmar</button>
                            <button class="btn-product-card secondary" onclick="updateReservaStatus('${r.id}','Completado')">Completar</button>
                            <button class="btn-product-card danger" onclick="updateReservaStatus('${r.id}','Cancelado')">Cancelar</button>
                        ` : '<em>Solo lectura</em>'}
                    </td>`;
                reservasTableBody.appendChild(tr);
            });
        }

        async function updateReservaStatus(reservaId, status) {
            try {
                const { error } = await supabaseClient
                    .from('reservations')
                    .update({ status })
                    .eq('id', reservaId);
                if (error) throw error;
                reservasData = reservasData.map(r => r.id === reservaId ? { ...r, status } : r);
                renderReservasUI();
            } catch (e) {
                showToast('No fue posible actualizar la reserva. Verifica permisos o RLS.', 'error');
                console.error(e);
            }
        }

        function renderCalendar() {
            if (!calendar) {
                calendar = new FullCalendar.Calendar(calendarContainer, {
                    initialView: 'dayGridMonth',
                    height: 'auto',
                    locale: 'es',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,listWeek'
                    },
                    events: reservasData.map(r => ({
                        id: r.id,
                        title: `${r.customer} • ${r.status || 'Pendiente'}`,
                        start: r.date
                    }))
                });
                calendar.render();
            } else {
                calendar.removeAllEvents();
                calendar.addEventSource(reservasData.map(r => ({
                    id: r.id,
                    title: `${r.customer} • ${r.status || 'Pendiente'}`,
                    start: r.date
                })));
            }
        }

        // --- 6. PRODUCTOS ---
        function slugify(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .replace(/^-+/, '')
                .replace(/-+$/, '');
        }

        function readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function extractStoragePathFromUrl(url) {
            if (!url) return null;
            const marker = '/product-images/';
            const index = url.indexOf(marker);
            if (index === -1) return null;
            const pathWithParams = url.substring(index + marker.length);
            return pathWithParams.split('?')[0];
        }

        function debounce(fn, delay = 250) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn(...args), delay);
            };
        }

        function showToast(message, variant = 'info') {
            if (!dashboardToast) {
                if (variant === 'error') console.error(message);
                else console.log(message);
                return;
            }
            dashboardToast.textContent = message;
            dashboardToast.className = `dashboard-toast show ${variant}`;
            clearTimeout(toastTimeoutId);
            toastTimeoutId = setTimeout(() => {
                dashboardToast.classList.remove('show');
            }, 4000);
        }

        function toggleProductsLoadingState(isLoading) {
            productsLoading = isLoading;
            if (productsLoadingIndicator) {
                productsLoadingIndicator.hidden = !isLoading;
            }
        }

        function normalizeText(value) {
            return (value || '').toString().toLowerCase().trim();
        }

        function getUniqueCategoriesList(products = []) {
            return Array.from(new Set(
                products
                    .map(p => (p.category || '').trim())
                    .filter(Boolean)
            )).sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
        }

        function populateCategoryFilter(products = []) {
            const categories = getUniqueCategoriesList(products);
            if (productCategoryFilter) {
                const previousValue = productFilters.category || 'all';
                productCategoryFilter.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = 'all';
                defaultOption.textContent = 'Todas las categorías';
                productCategoryFilter.appendChild(defaultOption);

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    productCategoryFilter.appendChild(option);
                });

                if (categories.includes(previousValue)) {
                    productCategoryFilter.value = previousValue;
                } else {
                    productCategoryFilter.value = 'all';
                    productFilters.category = 'all';
                }
            }
            updateCategorySelectOptions(categories);
        }

        function toggleNewCategoryInput(show) {
            if (!newCategoryWrapper) return;
            newCategoryWrapper.style.display = show ? 'block' : 'none';
            if (!show && productCategoryNewInput) {
                productCategoryNewInput.value = '';
            }
            if (show && productCategoryNewInput) {
                productCategoryNewInput.focus();
            }
        }

        function updateCategorySelectOptions(categories = [], selectedValue = '') {
            if (!productCategorySelectInput) return;
            const uniqueCategories = Array.from(new Set(categories)).filter(Boolean);
            const previousSelection = selectedValue || productCategorySelectInput.value || '';
            productCategorySelectInput.innerHTML = '';

            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.disabled = true;
            placeholderOption.textContent = 'Selecciona una categoría';
            productCategorySelectInput.appendChild(placeholderOption);

            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                productCategorySelectInput.appendChild(option);
            });

            const createOption = document.createElement('option');
            createOption.value = NEW_CATEGORY_VALUE;
            createOption.textContent = '➕ Crear nueva categoría';
            productCategorySelectInput.appendChild(createOption);

            if (previousSelection && previousSelection !== NEW_CATEGORY_VALUE && uniqueCategories.includes(previousSelection)) {
                productCategorySelectInput.value = previousSelection;
            } else if (previousSelection === NEW_CATEGORY_VALUE) {
                productCategorySelectInput.value = NEW_CATEGORY_VALUE;
            } else {
                productCategorySelectInput.value = '';
            }

            if (!productCategorySelectInput.value && previousSelection && previousSelection !== NEW_CATEGORY_VALUE) {
                const tempOption = document.createElement('option');
                tempOption.value = previousSelection;
                tempOption.textContent = previousSelection;
                productCategorySelectInput.insertBefore(tempOption, createOption);
                productCategorySelectInput.value = previousSelection;
            }

            toggleNewCategoryInput(productCategorySelectInput.value === NEW_CATEGORY_VALUE);
        }

        function updateProductStats(products = []) {
            if (productTotalCount) productTotalCount.textContent = products.length;
            if (productCategoryCount) {
                const categories = new Set(products.map(p => (p.category || '').trim()).filter(Boolean));
                productCategoryCount.textContent = categories.size;
            }
            if (productMissingImagesCount) {
                const missing = products.filter(p => !Array.isArray(p.images) || p.images.length === 0).length;
                productMissingImagesCount.textContent = missing;
            }
        }

        function getProductDateValue(product) {
            const raw = product?.updated_at || product?.created_at || product?.inserted_at || product?.published_at;
            const time = raw ? new Date(raw).getTime() : 0;
            return Number.isNaN(time) ? 0 : time;
        }

        function getFilteredProducts() {
            let list = Array.isArray(productsData) ? [...productsData] : [];
            if (productFilters.query) {
                const query = productFilters.query;
                list = list.filter(product =>
                    [product.title, product.description, product.category]
                        .some(field => normalizeText(field).includes(query))
                );
            }
            if (productFilters.category && productFilters.category !== 'all') {
                list = list.filter(product => normalizeText(product.category) === normalizeText(productFilters.category));
            }
            switch (productFilters.sort) {
                case 'price_desc':
                    list.sort((a, b) => (b.price || 0) - (a.price || 0));
                    break;
                case 'price_asc':
                    list.sort((a, b) => (a.price || 0) - (b.price || 0));
                    break;
                case 'name_asc':
                    list.sort((a, b) => normalizeText(a.title).localeCompare(normalizeText(b.title), 'es'));
                    break;
                default:
                    list.sort((a, b) => getProductDateValue(b) - getProductDateValue(a));
            }
            return list;
        }

        function renderProductsUI() {
            populateCategoryFilter(productsData);
            updateProductStats(productsData);
            const filtered = getFilteredProducts();
            displayProductsInTable(filtered);
        }

        async function loadProductsData(forceReload = false) {
            if (productsLoading && !forceReload) return;
            if (productsLoading && forceReload) {
                showToast('Ya estamos sincronizando los productos…', 'info');
                return;
            }
            toggleProductsLoadingState(true);
            try {
                const { data, error } = await supabaseClient
                    .from('products')
                    .select('*');
                if (error) throw error;
                productsData = Array.isArray(data) ? data : [];
                renderProductsUI();
            } catch (error) {
                console.error('Error cargando productos:', error);
                showToast('No pudimos cargar los productos. Intenta nuevamente.', 'error');
            } finally {
                toggleProductsLoadingState(false);
            }
        }

        function displayProductsInTable(products) {
            if (!productsTableBody) return;
            const hasFilters = Boolean(productFilters.query) || productFilters.category !== 'all';
            productsTableBody.innerHTML = '';
            if (!products || products.length === 0) {
                if (productsEmptyState) {
                    productsEmptyState.hidden = false;
                    if (productsEmptyMessage) {
                        productsEmptyMessage.textContent = hasFilters
                            ? 'No encontramos productos para los filtros seleccionados.'
                            : 'Aún no hay productos. ¡Agrega el primero!';
                    }
                }
                productsTableBody.innerHTML = '<tr><td colspan="5">No hay productos para mostrar.</td></tr>';
                return;
            }
            if (productsEmptyState) {
                productsEmptyState.hidden = true;
            }
            const rowsHtml = products.map(product => {
                const actions = isAdmin
                    ? `<button class="btn-product-card secondary" onclick="editProduct('${product.id}')">Editar</button>
                       <button class="btn-product-card danger" onclick="deleteProduct('${product.id}')">Eliminar</button>`
                    : '<em>Solo lectura</em>';
                const imageSrc = (Array.isArray(product.images) && product.images.length > 0)
                    ? product.images[0]
                    : '/assets/logo-oma-final.png';
                const priceLabel = typeof product.price === 'number'
                    ? formatCLP(product.price)
                    : '$0';
                return `
                    <tr>
                        <td>
                            <img src="${imageSrc}"
                                 alt="${product.title || 'Producto'}"
                                 style="width:60px; height:60px; object-fit:cover; border-radius:8px;">
                        </td>
                        <td>${product.title || 'Sin título'}</td>
                        <td>${product.category || 'Sin categoría'}</td>
                        <td>${priceLabel}</td>
                        <td class="product-actions">${actions}</td>
                    </tr>
                `;
            }).join('');
            productsTableBody.innerHTML = rowsHtml;
        }

        function openProductModal(product = null) {
            productForm.reset();
            imagePreviewsContainer.innerHTML = '';
            document.getElementById('product-id').value = '';
            removedImageUrls = new Set();
            const categoriesList = getUniqueCategoriesList(productsData);
            const selectedCategory = product?.category || '';
            updateCategorySelectOptions(categoriesList, selectedCategory);
            toggleNewCategoryInput(productCategorySelectInput && productCategorySelectInput.value === NEW_CATEGORY_VALUE);
            if (productCategoryNewInput) productCategoryNewInput.value = '';

            if (product) {
                modalProductTitleForm.textContent = 'Editar Producto';
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-title').value = product.title;
                document.getElementById('product-description').value = product.description;
                document.getElementById('product-price').value = product.price;
                if (product.images && product.images.length > 0) {
                    product.images.forEach(imgUrl => {
                        const preview = document.createElement('div');
                        preview.className = 'image-preview-item';
                        preview.innerHTML = `
                            <img src="${imgUrl}" alt="preview">
                            <button type="button" class="remove-preview-btn" data-url="${imgUrl}">&times;</button>`;
                        imagePreviewsContainer.appendChild(preview);
                    });
                }
            } else {
                modalProductTitleForm.textContent = 'Agregar Nuevo Producto';
            }
            productModal.style.display = 'flex';
        }

        function closeProductModal() {
            productModal.style.display = 'none';
        }

        async function handleProductFormSubmit(event) {
            event.preventDefault();
            if (!isAdmin) {
                showToast('No tienes permisos para modificar el catálogo.', 'error');
                return;
            }
            const formButton = event.target.querySelector('button[type="submit"]');
            formButton.disabled = true;
            const originalLabel = formButton.textContent;
            formButton.textContent = 'Guardando...';

            const productId = document.getElementById('product-id').value.trim();
            const title = document.getElementById('product-title').value.trim();
            const description = document.getElementById('product-description').value.trim();
            const priceValue = parseFloat(document.getElementById('product-price').value);
            const price = Number.isNaN(priceValue) ? 0 : Math.max(0, Math.round(priceValue));
            const imageInput = document.getElementById('product-images');
            const imageFiles = imageInput ? Array.from(imageInput.files || []) : [];
            let category = '';
            if (productCategorySelectInput) {
                const selectedCategory = productCategorySelectInput.value;
                if (selectedCategory === NEW_CATEGORY_VALUE) {
                    category = (productCategoryNewInput?.value || '').trim();
                    if (!category) {
                        showToast('Escribe un nombre para la nueva categoría.', 'error');
                        formButton.disabled = false;
                        formButton.textContent = originalLabel;
                        productCategoryNewInput?.focus();
                        return;
                    }
                } else if (selectedCategory) {
                    category = selectedCategory;
                } else {
                    showToast('Selecciona una categoría para el producto.', 'error');
                    formButton.disabled = false;
                    formButton.textContent = originalLabel;
                    productCategorySelectInput.focus();
                    return;
                }
            }

            if (!title || !description || !category) {
                showToast('Completa todos los campos antes de guardar.', 'error');
                formButton.disabled = false;
                formButton.textContent = originalLabel;
                return;
            }

            let imageUrls = [];
            if (productId) {
                const existingProduct = productsData.find(p => p.id === productId);
                if (existingProduct) {
                    imageUrls = (existingProduct.images || []).filter(u => !removedImageUrls.has(u));
                }
            }

            try {
                if (imageFiles.length > 0) {
                    for (const file of imageFiles) {
                        const dataUrl = await readFileAsDataUrl(file);
                        if (dataUrl) imageUrls.push(dataUrl);
                    }
                }

                const productPayload = {
                    title,
                    description,
                    category,
                    price,
                    images: imageUrls
                };

                if (productId) {
                    const { error } = await supabaseClient
                        .from('products')
                        .update(productPayload)
                        .eq('id', productId);
                    if (error) throw error;
                    showToast('Producto actualizado correctamente.', 'success');
                } else {
                    const { error } = await supabaseClient
                        .from('products')
                        .insert([productPayload]);
                    if (error) throw error;
                    showToast('Producto agregado con éxito.', 'success');
                }

                closeProductModal();
                removedImageUrls = new Set();
                if (imageInput) imageInput.value = '';
                await loadProductsData(true);
            } catch (err) {
                console.error('Error guardando producto:', err);
                showToast(`Error al guardar el producto: ${err.message || err}`, 'error');
            } finally {
                formButton.disabled = false;
                formButton.textContent = originalLabel;
            }
        }

        imagePreviewsContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.remove-preview-btn');
            if (!btn) return;
            const url = btn.dataset.url;
            if (url) removedImageUrls.add(url);
            const item = btn.parentElement;
            if (item) item.remove();
        });

        function editProduct(productId) {
            const product = productsData.find(p => p.id == productId);
            if (product) openProductModal(product);
        }

        async function deleteProduct(productId) {
            if (!isAdmin) {
                showToast('No tienes permisos para eliminar productos.', 'error');
                return;
            }
            const productToDelete = productsData.find(p => p.id == productId);
            const productName = productToDelete?.title || 'este producto';
            if (!confirm(`¿Eliminar "${productName}" del catálogo?`)) return;

            try {
                const filePaths = (productToDelete?.images || [])
                    .map(extractStoragePathFromUrl)
                    .filter(Boolean);
                if (filePaths.length > 0) {
                    try {
                        const { error: removeError } = await supabaseClient
                            .storage.from('product-images')
                            .remove(filePaths);
                        if (removeError && !String(removeError.message || removeError).includes('Bucket not found')) {
                            console.error('Error eliminando imágenes de Storage:', removeError);
                        }
                    } catch (storageErr) {
                        console.warn('No se pudo acceder al bucket product-images:', storageErr);
                    }
                }

                const { error } = await supabaseClient
                    .from('products')
                    .delete()
                    .eq('id', productId);

                if (error) throw error;
                showToast('Producto eliminado correctamente.', 'success');
                await loadProductsData(true);
            } catch (err) {
                console.error('Error deleting product:', err);
                showToast('No se pudo eliminar el producto. Intenta nuevamente.', 'error');
            }
        }

        // --- 7. INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                handleLogout();
            });

            function switchView(view) {
                if (view === 'calendar') {
                    btnViewCalendar.classList.add('active');
                    btnViewList.classList.remove('active');
                    calendarView.classList.add('active');
                    listView.classList.remove('active');
                    renderCalendar();
                } else {
                    btnViewCalendar.classList.remove('active');
                    btnViewList.classList.add('active');
                    calendarView.classList.remove('active');
                    listView.classList.add('active');
                    renderReservasList();
                }
            }

            btnViewCalendar.addEventListener('click', () => switchView('calendar'));
            btnViewList.addEventListener('click', () => switchView('list'));
            document.getElementById('status-filter').addEventListener('change', renderReservasList);
            document.getElementById('date-filter').addEventListener('change', renderReservasList);

            addProductBtn.addEventListener('click', () => openProductModal());
            if (productsEmptyCtaBtn) {
                productsEmptyCtaBtn.addEventListener('click', () => openProductModal());
            }
            if (refreshProductsBtn) {
                refreshProductsBtn.addEventListener('click', () => loadProductsData(true));
            }
            if (quickAddProductBtn) {
                quickAddProductBtn.addEventListener('click', () => openProductModal());
            }
            if (productCategorySelectInput) {
                productCategorySelectInput.addEventListener('change', (event) => {
                    toggleNewCategoryInput(event.target.value === NEW_CATEGORY_VALUE);
                });
            }
            if (productSearchInput) {
                const handleSearchInput = debounce((event) => {
                    productFilters.query = normalizeText(event.target.value);
                    renderProductsUI();
                }, 250);
                productSearchInput.addEventListener('input', handleSearchInput);
            }
            if (productCategoryFilter) {
                productCategoryFilter.addEventListener('change', (event) => {
                    productFilters.category = event.target.value;
                    renderProductsUI();
                });
            }
            if (productSortSelect) {
                productSortSelect.value = productFilters.sort;
                productSortSelect.addEventListener('change', (event) => {
                    productFilters.sort = event.target.value;
                    renderProductsUI();
                });
            }
            if (productResetFiltersBtn) {
                productResetFiltersBtn.addEventListener('click', () => {
                    productFilters.query = '';
                    productFilters.category = 'all';
                    productFilters.sort = 'recent';
                    if (productSearchInput) productSearchInput.value = '';
                    if (productCategoryFilter) productCategoryFilter.value = 'all';
                    if (productSortSelect) productSortSelect.value = 'recent';
                    renderProductsUI();
                });
            }
            modalProductCloseBtn.addEventListener('click', closeProductModal);
            productForm.addEventListener('submit', handleProductFormSubmit);
        });

        // Funciones globales para onclick en HTML
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.updateReservaStatus = updateReservaStatus;
        window.viewReserva = (id) => alert(`Reserva ${id}`);
    </script>
</body>
</html>
