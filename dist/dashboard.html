<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Oma Wurst</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/public/assets/logo-oma-final.png" alt="Oma Wurst Logo" class="sidebar-logo">
                <h1 class="sidebar-title">Oma Wurst</h1>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="active"><a href="#" data-target="dashboard-section"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#" data-target="reservas-section"><i class="fas fa-calendar-alt"></i> Reservas</a></li>
                    <li><a href="#" data-target="productos-section"><i class="fas fa-box"></i> Productos</a></li>
                    <li><a href="#" data-target="usuarios-section"><i class="fas fa-users"></i> Usuarios</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="#" id="logout-button">Cerrar Sesión</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <h2 id="main-title">Panel de Administración</h2>
                <div class="admin-profile">
                    <span id="user-email"></span>
                    <i class="fas fa-user-circle"></i>
                </div>
            </header>

            <section id="dashboard-section" class="main-section active">
                <div class="kpi-cards">
                    <div class="kpi-card">
                        <h4>Usuarios Registrados</h4>
                        <p id="kpi-usuarios-registrados">--</p>
                    </div>
                    <div class="kpi-card">
                        <h4>Usuarios Activos</h4>
                        <p id="kpi-usuarios-activos">--</p>
                    </div>
                    <div class="kpi-card">
                        <h4>Nuevas Reservas (Mes)</h4>
                        <p id="kpi-nuevas-reservas">--</p>
                    </div>
                </div>
                <div class="data-table-section">
                    <h3>Últimas Reservas</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="ultimas-reservas-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="reservas-section" class="main-section">
                <div class="controls-section">
                    <div class="filters">
                        <select id="status-filter">
                            <option value="all">Todos los estados</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Confirmado">Confirmado</option>
                            <option value="Completado">Completado</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                        <input type="date" id="date-filter">
                    </div>
                    <div class="view-switcher">
                        <button id="btn-view-calendar" class="view-btn active"><i class="fas fa-calendar-alt"></i> Calendario</button>
                        <button id="btn-view-list" class="view-btn"><i class="fas fa-list"></i> Lista</button>
                    </div>
                </div>
                <div class="content-view">
                    <div id="calendar-view" class="view active">
                        <div id="calendar-container"></div>
                    </div>
                    <div id="list-view" class="view">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID Reserva</th>
                                        <th>Cliente</th>
                                        <th>Fecha de Entrega</th>
                                        <th>Estado</th>
                                        <th>Total</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="reservas-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="productos-section" class="main-section">
                <div class="controls-section">
                    <h3>Todos los Productos</h3>
                    <button id="add-product-btn" class="btn-product-card primary">
                        <i class="fas fa-plus"></i> Agregar Producto
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Título</th>
                                <th>Categoría</th>
                                <th>Precio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                        </tbody>
                    </table>
                </div>
            </section>

            <div id="product-modal" class="modal-admin">
                <div class="modal-admin-content">
                    <button id="modal-product-close-btn" class="modal-close-btn">×</button>
                    <h3 id="modal-product-title-form">Agregar Nuevo Producto</h3>
                    <form id="product-form">
                        <input type="hidden" id="product-id">
                        <div class="form-group">
                            <label for="product-title">Título</label>
                            <input type="text" id="product-title" required>
                        </div>
                        <div class="form-group">
                            <label for="product-description">Descripción</label>
                            <textarea id="product-description" rows="4" required></textarea>
                        </div>
                        <div class="form-group-row">
                            <div class="form-group">
                                <label for="product-category">Categoría</label>
                                <input type="text" id="product-category" required>
                            </div>
                            <div class="form-group">
                                <label for="product-price">Precio</label>
                                <input type="number" id="product-price" step="1" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="product-images">Imágenes (la primera será la principal)</label>
                            <input type="file" id="product-images" multiple accept="image/*">
                            <div id="image-previews" class="image-previews"></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-submit">Guardar Producto</button>
                        </div>
                    </form>
                </div>
            </div>

            <section id="usuarios-section" class="main-section">
                <h2>Gestión de Usuarios</h2>
                <p>Esta sección está en construcción.</p>
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- 1. CONFIGURACIÓN Y CONEXIÓN ---
        const SUPABASE_URL = 'https://kvhvvfsdztamglnkhbsa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2aHZ2ZnNkenRhbWdsbmtoYnNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMzk5MjYsImV4cCI6MjA2NjkxNTkyNn0.4SyQx5sHLymx-_r_KEqqH4S5-xxxBlXtU-YS9hsolnk';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- 2. ELEMENTOS DEL DOM ---
        const userEmailElement = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const mainTitle = document.getElementById('main-title');
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        const mainSections = document.querySelectorAll('.main-section');
        
        // Elementos de Reservas
        const calendarView = document.getElementById('calendar-view');
        const listView = document.getElementById('list-view');
        const btnViewCalendar = document.getElementById('btn-view-calendar');
        const btnViewList = document.getElementById('btn-view-list');
        const calendarContainer = document.getElementById('calendar-container');
        const reservasTableBody = document.getElementById('reservas-table-body');
        let calendar;
        let reservasData = [];

        // === INICIO: CÓDIGO AÑADIDO ===
        // Elementos de Productos
        const productsTableBody = document.getElementById('products-table-body');
        const addProductBtn = document.getElementById('add-product-btn');
        const productModal = document.getElementById('product-modal');
        const modalProductCloseBtn = document.getElementById('modal-product-close-btn');
        const productForm = document.getElementById('product-form');
        const modalProductTitleForm = document.getElementById('modal-product-title-form');
        const imagePreviewsContainer = document.getElementById('image-previews');
        let productsData = [];
        // === FIN: CÓDIGO AÑADIDO ===

        // --- 3. AUTENTICACIÓN Y SESIÓN ---
        async function checkSession() {
            const { data, error } = await supabaseClient.auth.getSession();
            if (error || !data.session) {
                window.location.href = 'login.html';
            } else {
                userEmailElement.textContent = data.session.user.email;
                setupNavigation();
                loadDashboardData();
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        // --- 4. LÓGICA DE NAVEGACIÓN SPA ---
        function setupNavigation() {
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    showSection(targetId);
                    document.querySelector('.sidebar-nav li.active').classList.remove('active');
                    link.parentElement.classList.add('active');
                });
            });
        }

        function showSection(targetId) {
            mainSections.forEach(section => section.classList.remove('active'));
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.classList.add('active');
                const link = document.querySelector(`a[data-target="${targetId}"]`);
                const linkText = link.textContent.trim();
                mainTitle.textContent = linkText === 'Dashboard' ? 'Panel de Administración' : `Gestión de ${linkText}`;
                
                // === INICIO: CÓDIGO MODIFICADO ===
                if (targetId === 'reservas-section' && reservasData.length === 0) {
                    loadReservasData();
                }
                if (targetId === 'productos-section' && productsData.length === 0) {
                    loadProductsData();
                }
                // === FIN: CÓDIGO MODIFICADO ===
            }
        }
        
        // --- 5. LÓGICA DE CARGA DE DATOS ---
        async function loadDashboardData() {
            console.log("Cargando datos del dashboard...");
            document.getElementById('kpi-usuarios-registrados').textContent = '1,250';
            document.getElementById('kpi-usuarios-activos').textContent = '340';
            document.getElementById('kpi-nuevas-reservas').textContent = '85';
        }

        async function loadReservasData() {
            // ... (código de reservas sin cambios) ...
        }
        
        // === INICIO: CÓDIGO AÑADIDO Y MODIFICADO ===
        // --- 6. FUNCIONES DE LA SECCIÓN DE PRODUCTOS ---

        function slugify(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')           // Replace spaces with -
                .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
                .replace(/\-\-+/g, '-')         // Replace multiple - with single -
                .replace(/^-+/, '')             // Trim - from start of text
                .replace(/-+$/, '');            // Trim - from end of text
        }

        async function loadProductsData() {
            const { data, error } = await supabaseClient.from('products').select('*').order('title', { ascending: true });
            if (error) {
                console.error('Error cargando productos:', error);
                return;
            }
            productsData = data;
            displayProductsInTable(productsData);
        }

        function displayProductsInTable(products) {
            productsTableBody.innerHTML = '';
            if (!products || products.length === 0) {
                productsTableBody.innerHTML = '<tr><td colspan="5">Aún no hay productos. ¡Agrega el primero!</td></tr>';
                return;
            }
            products.forEach(product => {
                const row = `
                    <tr>
                        <td><img src="${product.images && product.images.length > 0 ? product.images[0] : '/public/assets/logo-oma-final.png'}" alt="${product.title}" style="width:60px; height:60px; object-fit:cover; border-radius:8px;"></td>
                        <td>${product.title}</td>
                        <td>${product.category}</td>
                        <td>${product.price ? product.price.toLocaleString('es-CL') : '0'}</td>
                        <td class="product-actions">
                            <button class="btn-product-card secondary" onclick="editProduct('${product.id}')">Editar</button>
                            <button class="btn-product-card danger" onclick="deleteProduct('${product.id}')">Eliminar</button>
                        </td>
                    </tr>
                `;
                productsTableBody.innerHTML += row;
            });
        }

        function openProductModal(product = null) {
            productForm.reset();
            imagePreviewsContainer.innerHTML = '';
            document.getElementById('product-id').value = '';

            if (product) {
                modalProductTitleForm.textContent = 'Editar Producto';
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-title').value = product.title;
                document.getElementById('product-description').value = product.description;
                document.getElementById('product-category').value = product.category;
                document.getElementById('product-price').value = product.price;
                if (product.images && product.images.length > 0) {
                    product.images.forEach(imgUrl => {
                        const preview = document.createElement('div');
                        preview.className = 'image-preview-item';
                        preview.innerHTML = `<img src="${imgUrl}" alt="preview"><button type="button" class="remove-preview-btn" data-url="${imgUrl}">&times;</button>`;
                        imagePreviewsContainer.appendChild(preview);
                    });
                }
            } else {
                modalProductTitleForm.textContent = 'Agregar Nuevo Producto';
            }
            productModal.style.display = 'flex';
        }

        function closeProductModal() {
            productModal.style.display = 'none';
        }

        async function handleProductFormSubmit(event) {
            event.preventDefault();
            const formButton = event.target.querySelector('button[type="submit"]');
            formButton.disabled = true;
            formButton.textContent = 'Guardando...';

            const productId = document.getElementById('product-id').value;
            const title = document.getElementById('product-title').value;
            const description = document.getElementById('product-description').value;
            const category = document.getElementById('product-category').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const imageFiles = document.getElementById('product-images').files;
            
            let imageUrls = [];
            if (productId) {
                const existingProduct = productsData.find(p => p.id === productId);
                if (existingProduct) {
                    imageUrls = existingProduct.images || [];
                }
            }

            if (imageFiles.length > 0) {
                for (const file of imageFiles) {
                    const fileName = `public/${slugify(title)}-${Date.now()}-${file.name.replace(/\s/g, '_')}`;
                    const { data, error } = await supabaseClient.storage.from('product-images').upload(fileName, file);
                    if (error) {
                        alert('Error al subir una de las imágenes: ' + error.message);
                        formButton.disabled = false;
                        formButton.textContent = 'Guardar Producto';
                        return;
                    }
                    const { data: { publicUrl } } = supabaseClient.storage.from('product-images').getPublicUrl(data.path);
                    imageUrls.push(publicUrl);
                }
            }

            const productData = {
                id: productId || slugify(title),
                title,
                description,
                category,
                price,
                images: imageUrls
            };

            const { error } = await supabaseClient.from('products').upsert([productData], { onConflict: 'id' });

            if (error) {
                alert('Error al guardar el producto: ' + error.message);
                console.error('Error upserting product:', error);
            }
            
            formButton.disabled = false;
            formButton.textContent = 'Guardar Producto';
            closeProductModal();
            await loadProductsData();
        }

        function editProduct(productId) {
            const product = productsData.find(p => p.id == productId);
            if (product) openProductModal(product);
        }

        async function deleteProduct(productId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este producto?')) return;
            
            const productToDelete = productsData.find(p => p.id == productId);
            if (productToDelete && productToDelete.images && productToDelete.images.length > 0) {
                const filePaths = productToDelete.images.map(url => {
                    const urlParts = url.split('/');
                    return 'public/' + urlParts.slice(urlParts.indexOf('product-images') + 1).join('/');
                }).map(path => path.substring(path.indexOf('public/')));

                if(filePaths.length > 0) {
                    const { error: removeError } = await supabaseClient.storage.from('product-images').remove(filePaths);
                    if (removeError) {
                        console.error('Error eliminando imágenes de Storage:', removeError);
                    }
                }
            }

            const { error } = await supabaseClient.from('products').delete().eq('id', productId);
            if (error) {
                alert('Error al eliminar el producto.');
                console.error('Error deleting product:', error);
            } else {
                await loadProductsData();
            }
        }
        // === FIN: CÓDIGO AÑADIDO ===

        // --- 7. INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            checkSession();
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                handleLogout();
            });

            btnViewCalendar.addEventListener('click', () => {
                // ... (código de switch de calendario sin cambios) ...
            });
            btnViewList.addEventListener('click', () => {
                // ... (código de switch de lista sin cambios) ...
            });
            
            // === INICIO: CÓDIGO AÑADIDO ===
            addProductBtn.addEventListener('click', () => openProductModal());
            modalProductCloseBtn.addEventListener('click', closeProductModal);
            productForm.addEventListener('submit', handleProductFormSubmit);
            // === FIN: CÓDIGO AÑADIDO ===
        });
        
        // === INICIO: CÓDIGO AÑADIDO ===
        // Hacer las funciones de editar/eliminar accesibles globalmente para los onclick
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        // === FIN: CÓDIGO AÑADIDO ===

    </script>
</body>
</html>